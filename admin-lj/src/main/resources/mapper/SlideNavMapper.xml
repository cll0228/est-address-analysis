<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.lezhi.adminlj.mapper.SlideNavMapper">
	<resultMap id="BaseResultMap" type="com.lezhi.adminlj.pojo.District">
        <id column="district_id" property="districtId" jdbcType="INTEGER"/>
        <result column="district_name" property="districtName" jdbcType="VARCHAR"/>
        <result column="center_lng" property="centerLng" jdbcType="DOUBLE"/>
        <result column="center_lat" property="centerLat" jdbcType="DOUBLE"/>
        <collection property="townList" ofType="com.lezhi.adminlj.pojo.Town" javaType="ArrayList">
        	<id column="town_id" property="townId" jdbcType="INTEGER"/>
        	<result column="town_name" property="townName" jdbcType="VARCHAR"/>
        	<result column="longitude" property="longitude" jdbcType="DOUBLE"/>
        	<result column="latitude" property="latitude" jdbcType="DOUBLE"/>
        	<collection property="neighborhoodList" ofType="com.lezhi.adminlj.pojo.Neighborhood" javaType="ArrayList">
	        	<id column="neighborhood_id" property="neighborhoodId" jdbcType="DOUBLE"/>
	        	<result column="neighborhood_name" property="neighborhoodName" jdbcType="VARCHAR"/>
	        	<result column="neighborhood_addr" property="neighborhoodAddr" jdbcType="VARCHAR"/>
	        	<result column="lng" property="lng" jdbcType="DOUBLE"/>
	        	<result column="lat" property="lat" jdbcType="DOUBLE"/>
        	</collection>
        </collection>
    </resultMap>
    
    <select id="districtList" resultMap="BaseResultMap">
        SELECT
			d.district_id,
			d.district_name,
			d.center_lng,
			d.center_lat,
			t.town_id,
			t.town_name,
			t.longitude,
			t.latitude,
			n.neighborhood_id,
			n.neighborhood_name,
			n.neighborhood_addr,
			n.lng,
			n.lat
		FROM
			of_district d
		LEFT JOIN of_town t ON d.district_id = t.district_id
		LEFT JOIN of_neighborhood n ON t.town_id = n.town_id
    </select>
    
    <select id="districtCount" resultType="com.lezhi.adminlj.pojo.CountParam">
        SELECT
			a.*, b.levelHouseCount,
			a.households / b.levelHouseCount * 100 AS proportion
		FROM
			(
				SELECT
					count(a.TYPE_NAME) AS households,
					a.district_name AS levelName,
					a.of_district_id AS levelId,
					a.of_district_id
				FROM
					hsrjop.intelligence_hd_addr_info a
				WHERE
					district_name IS NOT NULL
				GROUP BY
					a.of_district_id
			) a
		INNER JOIN (
			SELECT
				of_district_id,
				sum(house_count) AS levelHouseCount
			FROM
				ocn_address.of_residence
			WHERE
				of_district_id IS NOT NULL
			GROUP BY
				of_district_id
		) b ON a.of_district_id = b.of_district_id
    </select>
    
    <select id="levelOneCount" resultType="com.lezhi.adminlj.pojo.CountParam">
        SELECT
			a.*, b.levelHouseCount,
			a.households / b.levelHouseCount * 100 AS proportion
		FROM
			(
				SELECT
					count(a.TYPE_NAME) AS households,
					a.town_name AS levelName,
					a.of_town_id AS levelId,
					a.of_town_id
				FROM
					hsrjop.intelligence_hd_addr_info a
				WHERE
					district_name IS NOT NULL
				AND 
					a.of_district_id = #{districtId}
				GROUP BY
					a.of_town_id
			) a
		INNER JOIN (
			SELECT
				of_town_id,
				sum(house_count) AS levelHouseCount
			FROM
				ocn_address.of_residence
			WHERE
				of_town_id IS NOT NULL
			AND 
				of_district_id = #{districtId}
			GROUP BY
				of_town_id
		) b ON a.of_town_id = b.of_town_id
    </select>
    
    <select id="levelTwoCount" resultType="com.lezhi.adminlj.pojo.CountParam">
        SELECT
			a.*, b.levelHouseCount,
			a.households / b.levelHouseCount * 100 AS proportion
		FROM
			(
				SELECT
					count(a.TYPE_NAME) AS households,
					a.neighborhood_name AS levelName,
					a.of_neighborhood_id AS levelId,
					a.of_neighborhood_id
				FROM
					hsrjop.intelligence_hd_addr_info a
				WHERE
					district_name IS NOT NULL
				AND 
					a.of_town_id = #{townId}
				GROUP BY
					a.of_neighborhood_id
			) a
		INNER JOIN (
			SELECT
				of_neighborhood_id,
				sum(house_count) AS levelHouseCount
			FROM
				ocn_address.of_residence
			WHERE
				of_neighborhood_id IS NOT NULL
			AND 
				of_town_id = #{townId}
			GROUP BY
				of_neighborhood_id
		) b ON a.of_neighborhood_id = b.of_neighborhood_id
    </select>
    
    <select id="levelThreeCount" resultType="com.lezhi.adminlj.pojo.CountParam">
        SELECT
			a.*, b.levelHouseCount,
			a.households / b.levelHouseCount * 100 AS proportion
		FROM
			(
				SELECT
					count(a.TYPE_NAME) AS households,
					a.residence_name AS levelName,
					a.residence_id AS levelId,
					a.residence_id
				FROM
					hsrjop.intelligence_hd_addr_info a
				WHERE
					district_name IS NOT NULL
				AND 
					a.of_neighborhood_id = #{neighborhoodId}
				GROUP BY
					a.residence_id
			) a
		INNER JOIN (
			SELECT
				id,
				sum(house_count) AS levelHouseCount
			FROM
				ocn_address.of_residence
			WHERE
				id IS NOT NULL
			AND 
				of_neighborhood_id = #{neighborhoodId}
			GROUP BY
				id
		) b ON a.residence_id = b.id
    </select>
</mapper>