<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lezhi.statistics.mapper.DataPlatformMapper">
    <select id="selectVistHis" resultType="com.lezhi.statistics.pojo.MacVisitHistoryInfo">
        SELECT mac, pv, unix_timestamp(begin_time) firstVisitTime,
        unix_timestamp(end_time) lastVisitTime, total_top totalTop FROM
        `channel_visit_summary` WHERE 1=1
        <if test="null != channelNo and '' != channelNo">
            AND channel_no = #{channelNo}
        </if>
        AND FROM_UNIXTIME(#{startTime},'%Y-%m-%d %H:%i:%s') &lt;= begin_time AND
        FROM_UNIXTIME(${startTime+span},'%Y-%m-%d %H:%i:%s') &gt;= end_time
        <if test="null != residenceId and '' != residenceId">
            AND residence_id = #{residenceId}
        </if>
        <if test="null != blockId and '' != blockId">
            AND block_id= #{blockId}
        </if>
        <if test="null != districtId and '' != districtId">
            AND district_id = #{districtId}
        </if>
    </select>
    <select id="realtime" resultType="com.lezhi.statistics.pojo.RealTimeSummaryObj">
        SELECT sum(uv) uv,sum(pv) pv,sum(nv) nv,unix_timestamp(refresh_time) refreshTime FROM
        <if test="residenceId != null and '' != residenceId">
            real_time_channel${channelNo}_residence WHERE residence_id = #{residenceId} AND period = #{period}
        </if>
        <if test="blockId != null and '' != blockId">
            real_time_channel${channelNo}_block WHERE block_id = #{blockId} AND period = #{period}
        </if>
        <if test="districtId != null and '' != districtId">
            real_time_channel${channelNo}_district WHERE district_id = #{districtId} AND period = #{period}
        </if>
        <if test="residenceId == null and blockId == null and districtId == null">
            real_time_channel${channelNo}_district WHERE period = #{period}
        </if>
    </select>
    <select id="current" resultType="com.lezhi.statistics.pojo.TrendObj">
        SELECT 	begin_time timeBegin,
        end_time timeEnd,
        uv,
        pv,
        nv,
        avg_top avgTop FROM
        <choose>
        <when test="scale = 60000">
            <if test="null != residenceId and '' != residenceId">
                realtime_trend_60m_residence WHERE residence_id = #{residenceId}
                <if test="null != channelNo and '' != channelNo">
                   AND channel_no = #{channelNo}
                </if>
            </if>
            <if test="null != blockId and '' != blockId">
                realtime_trend_60m_block WHERE block_id = #{blockId}
                <if test="null != channelNo and '' != channelNo">
                    AND channel_no = #{channelNo}
                </if>
            </if>
            <if test="null != districtId and '' != districtId">
                realtime_trend_60m_district WHERE district_id = #{districtId}
                <if test="null != channelNo and '' != channelNo">
                    AND channel_no = #{channelNo}
                </if>
            </if>
        </when>
        <otherwise>
            <if test="null != residenceId and '' != residenceId">
                realtime_trend_24h_residence WHERE residence_id = #{residenceId}
                <if test="null != channelNo and '' != channelNo">
                    AND channel_no = #{channelNo}
                </if>
            </if>
            <if test="null != blockId and '' != blockId">
                realtime_trend_24h_block WHERE block_id = #{blockId}
                <if test="null != channelNo and '' != channelNo">
                    AND channel_no = #{channelNo}
                </if>
            </if>
            <if test="null != districtId and '' != districtId">
                realtime_trend_24h_district WHERE district_id = #{districtId}
                <if test="null != channelNo and '' != channelNo">
                    AND channel_no = #{channelNo}
                </if>
            </if>
        </otherwise>
        </choose>
        AND FROM_UNIXTIME(#{startTime},'%Y-%m-%d %H:%i:%s') &lt;= begin_time AND
        FROM_UNIXTIME(${startTime+span},'%Y-%m-%d %H:%i:%s') &gt;= end_time
        GROUP BY begin_time DESC
    </select>

    <select id="his_current" resultType="com.lezhi.statistics.pojo.TrendObj">
        SELECT 	begin_time timeBegin,
        end_time timeEnd,
        uv,
        pv,
        nv,
        avg_top avgTop FROM
        <choose>
            <when test="scale = 3600000">
                <if test="null != residenceId and '' != residenceId">
                    his_trend_hour_residence WHERE residence_id = #{residenceId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
                <if test="null != blockId and '' != blockId">
                    his_trend_hour_block WHERE block_id = #{blockId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
                <if test="null != districtId and '' != districtId">
                    his_trend_hour_district WHERE district_id = #{districtId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
            </when>
            <otherwise>
                <if test="null != residenceId and '' != residenceId">
                    his_trend_day_residence WHERE residence_id = #{residenceId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
                <if test="null != blockId and '' != blockId">
                    his_trend_day_block WHERE block_id = #{blockId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
                <if test="null != districtId and '' != districtId">
                    his_trend_day_district WHERE district_id = #{districtId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
            </otherwise>
        </choose>
        AND FROM_UNIXTIME(#{startTime},'%Y-%m-%d %H:%i:%s') &lt;= begin_time AND
        FROM_UNIXTIME(${startTime+span},'%Y-%m-%d %H:%i:%s') &gt;= end_time
        GROUP BY begin_time DESC
    </select>

    <select id="contrastive" resultType="com.lezhi.statistics.pojo.TrendObj">
        SELECT 	begin_time timeBegin,
        end_time timeEnd,
        uv,
        pv,
        nv,
        avg_top avgTop FROM
        <choose>
            <when test="scale = 60000">
                <if test="null != residenceId and '' != residenceId">
                    realtime_trend_60m_residence WHERE residence_id = #{residenceId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
                <if test="null != blockId and '' != blockId">
                    realtime_trend_60m_block WHERE block_id = #{blockId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
                <if test="null != districtId and '' != districtId">
                    realtime_trend_60m_district WHERE district_id = #{districtId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
            </when>
            <otherwise>
                <if test="null != residenceId and '' != residenceId">
                    realtime_trend_24h_residence WHERE residence_id = #{residenceId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
                <if test="null != blockId and '' != blockId">
                    realtime_trend_24h_block WHERE block_id = #{blockId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
                <if test="null != districtId and '' != districtId">
                    realtime_trend_24h_district WHERE district_id = #{districtId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
            </otherwise>
        </choose>
        AND FROM_UNIXTIME(#{contrastiveStartTime},'%Y-%m-%d %H:%i:%s') &lt;= begin_time AND
        FROM_UNIXTIME(${contrastiveStartTime+span},'%Y-%m-%d %H:%i:%s') &gt;= end_time
        GROUP BY begin_time DESC
    </select>

    <select id="his_contrastive" resultType="com.lezhi.statistics.pojo.TrendObj">
        SELECT 	begin_time timeBegin,
        end_time timeEnd,
        uv,
        pv,
        nv,
        avg_top avgTop FROM
        <choose>
            <when test="scale = 3600000">
                <if test="null != residenceId and '' != residenceId">
                    his_trend_hour_residence WHERE residence_id = #{residenceId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
                <if test="null != blockId and '' != blockId">
                    his_trend_hour_block WHERE block_id = #{blockId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
                <if test="null != districtId and '' != districtId">
                    his_trend_hour_district WHERE district_id = #{districtId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
            </when>
            <otherwise>
                <if test="null != residenceId and '' != residenceId">
                    his_trend_day_residence WHERE residence_id = #{residenceId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
                <if test="null != blockId and '' != blockId">
                    his_trend_day_block WHERE block_id = #{blockId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
                <if test="null != districtId and '' != districtId">
                    his_trend_day_district WHERE district_id = #{districtId}
                    <if test="null != channelNo and '' != channelNo">
                        AND channel_no = #{channelNo}
                    </if>
                </if>
            </otherwise>
        </choose>
        AND FROM_UNIXTIME(#{contrastiveStartTime},'%Y-%m-%d %H:%i:%s') &lt;= begin_time AND
        FROM_UNIXTIME(${contrastiveStartTime+span},'%Y-%m-%d %H:%i:%s') &gt;= end_time
        GROUP BY begin_time DESC
    </select>

    <select id="summary" resultType="com.lezhi.statistics.pojo.ChannelSummaryObj">
        SELECT
        c.channel_no channelNo,
        c.pv pv,
        d.nv nv,
        c.uv uv
        FROM
        (
        SELECT
        a.channel_no,
        SUM(a.pv) pv,
        COUNT(DISTINCT a.mac) uv
        FROM
        statistics.channel_visit_summary a
        WHERE
        a.begin_time &gt;= FROM_UNIXTIME(#{startTime},'%Y-%m-%d %H:%i:%s')
        AND a.end_time &lt;= FROM_UNIXTIME(${startTime+span},'%Y-%m-%d %H:%i:%s')
        GROUP BY
        a.channel_no
        ) c,
        (
        SELECT
        COUNT(mac) nv,
        channel_no
        FROM
        statistics.channel_visit_summary a
        WHERE
        a.mac NOT IN (
        SELECT
        b.mac
        FROM
        statistics.new_visitor b
        )
        AND a.begin_time &gt;= FROM_UNIXTIME(#{startTime},'%Y-%m-%d %H:%i:%s')
				AND a.end_time &lt;= FROM_UNIXTIME(${startTime+span},'%Y-%m-%d %H:%i:%s')
        GROUP BY
        a.channel_no
        ) d
        WHERE
        c.channel_no = d.channel_no
        <if test="null != channelNo and '' != channelNo">
            AND c.channel_no = #{channelNo}
        </if>
    </select>
</mapper>