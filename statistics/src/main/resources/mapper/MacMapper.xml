<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lezhi.statistics.mapper.MacMapper">
	<resultMap id="BaseResultMap" type="com.lezhi.statistics.pojo.MacInfoObj">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="mac" property="mac" jdbcType="VARCHAR"/>
        <result column="residence_id" property="residenceId" jdbcType="INTEGER"/>
        <result column="residence_name" property="residenceName" jdbcType="VARCHAR"/>
        <result column="building_id" property="buildingId" jdbcType="INTEGER"/>
        <result column="building_no" property="buildingNo" jdbcType="VARCHAR"/>
        <result column="lon" property="lon" jdbcType="DOUBLE"/>
        <result column="lat" property="lat" jdbcType="DOUBLE"/>
        <result column="district_id" property="districtId" jdbcType="INTEGER"/>
        <result column="district" property="district" jdbcType="VARCHAR"/>
        <result column="block_id" property="blockId" jdbcType="INTEGER"/>
        <result column="block" property="block" jdbcType="VARCHAR"/>
        <result column="serial_no" property="serialNo" jdbcType="VARCHAR"/>
        <result column="res_code" property="resCode" jdbcType="VARCHAR"/>
        <result column="res_name" property="resName" jdbcType="VARCHAR"/>
        <result column="res_category" property="resCategory" jdbcType="VARCHAR"/>
    </resultMap>
	<select id="getMacInfoList" resultMap="BaseResultMap">
        SELECT
			a.*, b.district_name district,
			c.block_name block,
			d.residence_name,
			e.building_no
		FROM
			statistics.mac_info a
		LEFT JOIN ocn_address.of_district b ON a.district_id = b.district_id
		LEFT JOIN df_estate_db_v2.sh_block c ON a.block_id = c.block_id
		LEFT JOIN ocn_address.of_residence d ON a.residence_id = d.id
		LEFT JOIN ocn_address.of_building e ON a.building_id = e.id
		WHERE 1=1
        <if test="type == 1">
            AND a.district_id = #{id}
        </if>
        <if test="type == 2">
            AND a.block_id = #{id}
        </if>
        <if test="type == 3">
            AND a.residence_id = #{id}
        </if>
        LIMIT #{start},#{size}
    </select>
    
    <select id="checkId" resultType="java.lang.Integer">
        SELECT
			count(*)
		FROM
		<if test="type == 1">
            ocn_address.of_district
        </if>
        <if test="type == 2">
            ocn_address.of_town
        </if>
        <if test="type == 3">
            ocn_address.of_residence
        </if>
        WHERE
        <if test="type == 1">
        	district_id = #{id}
        </if>
        <if test="type == 2">
            town_id = #{id}
        </if>
        <if test="type == 3">
            id = #{id}
        </if>
    </select>
    
    <select id="totalCount" resultType="java.lang.Integer">
        SELECT
			count(*)
		FROM
			statistics.mac_info a
		WHERE 1=1
        <if test="type == 1">
            AND a.district_id = #{id}
        </if>
        <if test="type == 2">
            AND a.block_id = #{id}
        </if>
        <if test="type == 3">
            AND a.residence_id = #{id}
        </if>
    </select>
    
    <select id="getMacInfo" resultMap="BaseResultMap">
        SELECT
			a.*, b.district_name district,
			c.block_name block,
			d.residence_name,
			e.building_no
		FROM
			statistics.mac_info a
		LEFT JOIN ocn_address.of_district b ON a.district_id = b.district_id
		LEFT JOIN df_estate_db_v2.sh_block c ON a.block_id = c.block_id
		LEFT JOIN ocn_address.of_residence d ON a.residence_id = d.id
		LEFT JOIN ocn_address.of_building e ON a.building_id = e.id
		WHERE
			a.mac = #{mac}
		LIMIT 0,1
    </select>

    <select id="getMacVisitLog" resultType="com.lezhi.statistics.pojo.MacVisitLogInfo">
        SELECT
		  a.id, a.mac,a.channel_no as channelNo,a.district_id as districtId,a.block_id as blockId,a.residence_id as residenceId
		  ,unix_timestamp(a.create_time)*1000 as `time`,a.district_name as districtName,a.block_name as blockName
		  ,a.residence_name as residenceName
          ,a.first_visit_id_if_ever_visited as firstVisitIdIfEverVisited
		FROM
			mac_visit_log a
		WHERE 1=1
		<if test="mac != null">
            AND a.mac = #{mac}
        </if>
        <if test="null != channelNo and '' != channelNo and 'all' != channelNo">
            AND a.channel_no = #{channelNo}
        </if>
        <if test="startTime != null" >
            AND a.create_time &gt;= FROM_UNIXTIME(#{startTime},'%Y-%m-%d %H:%i:%s')
        </if>
        <if test="endTime != null" >
            AND a.create_time &lt;= FROM_UNIXTIME(#{endTime},'%Y-%m-%d %H:%i:%s')
        </if>
        <if test="null != residenceId and '' != residenceId">
            AND a.residence_id = #{residenceId}
        </if>
        <if test="null != blockId and '' != blockId">
            AND a.block_id= #{blockId}
        </if>
        <if test="null != districtId and '' != districtId">
            AND a.district_id = #{districtId}
        </if>
        <if test="minIdExclude != null">
            AND a.id > #{minIdExclude}
        </if>
        order by a.create_time desc
    </select>

    <select id="selectForRealtimeSummary" resultType="com.lezhi.statistics.pojo.MacVisitLogInfo">
        select
        a.mac,a.channel_no as channelNo,a.district_id as districtId,a.block_id as blockId,a.residence_id as residenceId,a.create_time as `time`
        from mac_visit_log a
        where a.create_time >= #{timeFrom} and a.create_time &lt;= #{now}
        <if test="channelNo != null and channelNo != 'all'">
            and a.channel_no = #{channelNo}
        </if>
        <if test="districtId != null">
            and a.district_id = #{districtId}
        </if>
        <if test="blockId != null">
            and a.block_id = #{blockId}
        </if>
        <if test="residenceId != null">
            and a.residence_id = #{residenceId}
        </if>
    </select>

    <select id="nvForRealtimeSummary" resultType="java.lang.Integer">
        select
        count( distinct a.mac)
        from mac_visit_log a left join new_visitor b on a.mac = b.mac
        <if test="channelNo != null and channelNo != 'all'">
            and a.channel_no = b.channel_no
        </if>
        and b.first_visit_time &lt;= #{timeFrom}

        where a.create_time >= #{timeFrom} and a.create_time &lt;= #{now}
        and b.id is null
        <if test="channelNo != null and channelNo != 'all'">
            and a.channel_no = #{channelNo}
        </if>
        <if test="districtId != null">
            and a.district_id = #{districtId}
        </if>
        <if test="blockId != null">
            and a.block_id = #{blockId}
        </if>
        <if test="residenceId != null">
            and a.residence_id = #{residenceId}
        </if>
        AND a.mac is not null
    </select>

    <insert id="newVisitorSchedule">
        INSERT INTO statistics.new_visitor(channel_no, mac, first_visit_time)
           SELECT a.channel, a.mac, max(a.`timestamp`)
           FROM api_logs_shfctv a
                LEFT JOIN new_visitor b ON a.mac = b.mac AND a.channel = b.channel_no
           WHERE b.id IS NULL
           GROUP BY a.mac, a.channel
    </insert>
</mapper>